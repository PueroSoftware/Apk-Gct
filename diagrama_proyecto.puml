@startuml
!theme vibrant
skinparam classAttributeIconSize 0
skinparam componentStyle uml2

title Diagrama de Arquitectura Final - GeoCellTrack

' Declaración de Actores
actor "Usuario" as User

' Declaración de Paquetes de la App
package "Capa de Presentación (UI)" {
    component "MainActivity" as MainActivity
    component "PowerActivity" as PowerActivity
    component "RunningActivity" as RunningActivity
}

package "Capa de Fondo (Background)" {
    component "TrackerService" as TrackerService
    component "BootReceiver" as BootReceiver
    component "DetectedActivityReceiver" as DetectedActivityReceiver
}

package "Capa de Red & Lógica" {
    component "GroqClient" as GroqClient
}

' Declaración de Almacenamiento y Sistema
database "SharedPreferences" as Prefs
boundary "Sistema Android" as AndroidSystem

' Declaración de Servicios en la Nube
cloud "Servicios en la Nube" {
    node "Firebase" {
        database "Realtime Database" as RTDB {
            folder "users/{userId}"
            folder "geocelltrack/tracker/{userId}"
        }
        database "Firestore" as FS {
            folder "profiles/{userId}"
        }
        component "Auth (Email/Pass)" as Auth
    }
    node "Groq Cloud" {
        component "Llama 3 API" as AI
    }
}

' --- RELACIONES DE FLUJO Y DATOS ---

User -> MainActivity : 1. Inicia App y se autentica
MainActivity -> Auth : 2. Valida credenciales (Email/Contraseña)
MainActivity -> RTDB : 3. Guarda/Actualiza perfil en Realtime
MainActivity -> FS : 3. Guarda/Actualiza perfil en Firestore
MainActivity -> Prefs : 4. Guarda userId para reinicios
MainActivity ..> PowerActivity : 5. Navega tras login exitoso

PowerActivity ..> TrackerService : 6. Inicia servicio
PowerActivity ..> RunningActivity : 7. Navega a monitoreo

RunningActivity o--> TrackerService : 8. Se enlaza (bind) para recibir datos
RunningActivity -> GroqClient : 9. Pide análisis de IA
GroqClient --> AI : 10. Llama a la API de Groq

' --- RELACIONES DE SEGUNDO PLANO ---

AndroidSystem --> BootReceiver : (BOOT_COMPLETED)
BootReceiver -> Prefs : Lee userId
BootReceiver ..> TrackerService : Reinicia el servicio

AndroidSystem --> DetectedActivityReceiver : (Actividad Detectada)
DetectedActivityReceiver ..> TrackerService : (Informa para ajustar intervalo)

TrackerService --> AndroidSystem : (Pide GPS y datos de red)
TrackerService -> RTDB : Guarda datos de rastreo
TrackerService -> Prefs : Guarda/Lee datos offline (caja negra)

@enduml
